<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Acta de Entrega - RAMO (V2.2)</title>
  
  <style>
    /* --- ESTILOS CSS --- */
    * { box-sizing: border-box; }

    body, html {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", "Roboto", Helvetica, Arial, sans-serif;
      background-color: #f4f6f8;
      color: #333;
    }

    .main-container {
        max-width: 750px;
        margin: 30px auto;
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.08);
        overflow: hidden;
        padding-bottom: 30px;
    }

    header {
        text-align: center;
        padding: 25px;
        border-bottom: 1px solid #eee;
        background: #fff;
    }

    .logo { max-width: 150px; margin-bottom: 10px; }

    h1 {
        font-size: 1.4rem;
        color: #B70000; /* Rojo Ramo */
        margin: 0;
    }

    /* Condiciones */
    .condiciones-uso {
        background-color: #fff5f5;
        border-left: 5px solid #B70000;
        margin: 20px 30px;
        padding: 15px;
        font-size: 0.85rem;
        color: #555;
        line-height: 1.5;
        text-align: justify;
    }
    .condiciones-uso h3 { margin-top: 0; color: #B70000; }
    .condiciones-uso p { margin-bottom: 8px; }

    /* Formulario */
    form { padding: 0 30px; }

    .seccion-header {
        background-color: #333;
        color: #fff;
        padding: 10px 15px;
        margin-top: 30px;
        margin-bottom: 20px;
        border-radius: 6px;
        font-weight: 600;
        display: flex;
        align-items: center;
    }
    .seccion-header .numero {
        background-color: #B70000;
        color: white;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-size: 0.8rem;
    }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }

    label {
        display: block;
        margin-top: 15px;
        margin-bottom: 5px;
        font-weight: 600;
        font-size: 0.9rem;
        color: #444;
    }

    input, select, textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 0.95rem;
    }
    
    input:focus, select:focus {
        border-color: #B70000;
        outline: none;
    }

    .input-readonly {
        background-color: #f9f9f9;
        color: #666;
        cursor: not-allowed;
    }

    /* Buscador */
    .input-group-search {
        display: flex;
        gap: 10px;
    }
    .btn-search {
        background-color: #B70000;
        color: white;
        border: none;
        padding: 0 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .btn-search:hover { background-color: #900000; }
    
    /* Estado de b√∫squeda */
    .msg-estado {
        margin-top: 5px;
        font-size: 0.9rem;
        min-height: 20px;
        font-weight: bold;
    }

    /* Tabla Inventario */
    .tabla-container { overflow-x: auto; margin-bottom: 20px; }
    .tabla-inventario { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
    .tabla-inventario th { background: #f4f4f4; padding: 10px; border: 1px solid #ddd; }
    .tabla-inventario td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    
    .radio-group { display: flex; justify-content: center; gap: 15px; }
    .radio-group label { font-weight: normal; margin: 0; cursor: pointer; }
    .radio-group input { width: auto; margin-right: 5px; }

    /* Firmas */
    .firma-card {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
        border-radius: 8px;
    }
    .canvas-firma {
        border: 2px dashed #ccc;
        background: #fff;
        width: 100%;
        height: 120px;
        touch-action: none;
    }
    .btn-clear {
        background: #eee; border: none; padding: 5px 10px;
        border-radius: 4px; cursor: pointer; margin-top: 5px;
    }

    /* Bot√≥n Final */
    .btn-principal {
        width: 100%;
        padding: 15px;
        background-color: #B70000;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        margin-top: 20px;
    }
    .btn-principal:hover { background-color: #900000; }

    /* Spinner Animado */
    .spinner {
        display: inline-block;
        width: 16px; 
        height: 16px; 
        border: 3px solid rgba(255,255,255,0.3); 
        border-radius: 50%; 
        border-top-color: #fff; /* Blanco para ver sobre rojo */
        animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 600px) {
        .grid-2, .grid-3 { grid-template-columns: 1fr; }
        .input-group-search { flex-direction: column; }
        .btn-search { width: 100%; justify-content: center; padding: 10px; }
    }
  </style>
</head>
<body>

<div class="main-container">
    <header>
        <!-- Si no tienes el logo local, usa este enlace temporal o pon tu archivo -->
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a6/Ramo_logo.svg/1200px-Ramo_logo.svg.png" alt="Logo RAMO" class="logo" style="max-width: 120px;" />
        <h1>Acta de Entrega de Dispositivos M√≥viles</h1>
    </header>

    <div class="condiciones-uso">
        <h3>Condiciones de uso:</h3>
        <p>Los elementos son de uso exclusivo de la Organizaci√≥n Ramo para la ejecuci√≥n de sus actividades Comerciales.</p>
        <p>El anterior equipo y los accesorios no podr√°n ser utilizados para otras labores distintas a las establecidas para la venta, ni manipulados por terceras personas.</p>
        <p>Cualquier da√±o o p√©rdida por negligencia har√° responsable al funcionario del costo estipulado.</p>
        <p>En caso de novedad, informar al Jefe inmediato para tr√°mite respectivo.</p>
        <p>Si el funcionario se retira, deber√° entregar los elementos en las mismas condiciones.</p>
    </div>

    <form id="formulario">
        
        <!-- 1. COLABORADOR -->
        <div class="seccion-header"><span class="numero">1</span> Datos del Colaborador</div>

        <div class="grid-2">
            <div><label>Ciudad:</label><input type="text" id="ciudad" required placeholder="Ej: Bogot√°"></div>
            <div><label>Fecha:</label><input type="text" id="fecha" readonly class="input-readonly"></div>
        </div>

        <label>C√©dula Colaborador:</label>
        <div class="input-group-search">
            <input type="text" id="cedula" required placeholder="Ingrese c√©dula sin puntos">
            <button type="button" class="btn-search" onclick="buscarColaborador()">
                <span id="icono-busqueda-colaborador">üîç</span> Buscar
            </button>
        </div>
        <div id="msg-colaborador" class="msg-estado"></div>

        <label>Nombre:</label><input type="text" id="nombre_colaborador" readonly class="input-readonly">
        
        <div class="grid-2">
            <div><label>Agencia:</label><input type="text" id="agencia" readonly class="input-readonly"></div>
            <div><label>Tel√©fono:</label><input type="text" id="telefono" readonly class="input-readonly"></div>
        </div>

        <label>Correo Electr√≥nico:</label>
        <input type="email" id="correo_colaborador" required placeholder="nombre@ramo.com.co">

        <div class="grid-2">
            <div><label>Zona:</label><input type="text" id="zona_colaborador" required></div>
            <div>
                <label>Cargo / Operaci√≥n:</label>
                <select id="operacion" required>
                    <option value="">Seleccione...</option>
                    <option value="Gestor PV">Gestor PV</option>
                    <option value="Preventa">Preventa</option>
                    <option value="Canal Moderno">Canal Moderno</option>
                    <option value="Log√≠stica">Log√≠stica</option>
                    <option value="Eagle">Eagle</option>
                    <option value="Administrativo">Administrativo</option>
                    <option value="Agencia">Agencia</option>
                </select>
            </div>
        </div>

        <!-- 2. INVENTARIO -->
        <div class="seccion-header"><span class="numero">2</span> Inventario del Dispositivo</div>

        <div class="grid-3">
            <div><label>Tipo:</label><input type="text" id="tipo_equipo" value="Handheld" readonly class="input-readonly" style="color:#B70000; font-weight:bold;"></div>
            <div>
                <label>Marca:</label>
                <select id="marca" required>
                    <option value="">Seleccione...</option>
                    <option value="Zebra">Zebra</option>
                    <option value="Samsung">Samsung</option>
                    <option value="Cyrus">Cyrus</option>
                    <option value="Ulefone">Ulefone</option>
                </select>
            </div>
            <div>
                <label>Modelo:</label>
                <select id="modelo" required>
                    <option value="">Seleccione...</option>
                    <option value="TC26">TC26</option>
                    <option value="TC27">TC27</option>
                    <option value="Armor X8">Armor X8</option>
                    <option value="J5">J5</option>
                </select>
            </div>
        </div>

        <label>Serial (IMEI/SN):</label>
        <input type="text" id="serial" required placeholder="Escanee o digite">

        <p style="font-weight:bold; color:#B70000; margin-top:20px;">Estado de Accesorios:</p>
        <div class="tabla-container">
            <table class="tabla-inventario">
                <thead><tr><th>√çtem</th><th>¬øSe entrega?</th><th>Estado</th></tr></thead>
                <tbody>
                    <!-- Filas simplificadas para el ejemplo, agrega el resto si necesitas -->
                    <tr>
                        <td>Terminal M√≥vil</td>
                        <td><div class="radio-group"><label><input type="radio" name="entrega_terminal" value="Si" checked> Si</label><label><input type="radio" name="entrega_terminal" value="No"> No</label></div></td>
                        <td><select name="estado_terminal"><option value="Bueno">Bueno</option><option value="Regular">Regular</option><option value="Malo">Malo</option></select></td>
                    </tr>
                    <tr>
                        <td>Cargador</td>
                        <td><div class="radio-group"><label><input type="radio" name="entrega_cargador" value="Si"> Si</label><label><input type="radio" name="entrega_cargador" value="No" checked> No</label></div></td>
                        <td><select name="estado_cargador"><option value="Bueno">Bueno</option><option value="Regular">Regular</option><option value="Malo">Malo</option></select></td>
                    </tr>
                    <!-- Agrega aqu√≠ el resto de filas (Bater√≠a, Cable, etc.) copiando la estructura -->
                </tbody>
            </table>
        </div>

        <label>Observaciones:</label>
        <textarea id="observaciones" rows="3"></textarea>

        <!-- 3. ANALISTA -->
        <div class="seccion-header"><span class="numero">3</span> Datos del Analista (Quien Entrega)</div>

        <label>C√©dula Analista:</label>
        <div class="input-group-search">
            <input type="text" id="cedula_analista" required placeholder="Ingrese c√©dula sin puntos">
            <button type="button" class="btn-search" onclick="buscarAnalista()">
                <span id="icono-busqueda-analista">üîç</span> Buscar
            </button>
        </div>
        <div id="msg-analista" class="msg-estado"></div>

        <label>Nombre Analista:</label><input type="text" id="nombre_analista" readonly class="input-readonly">

        <div class="grid-2">
            <div><label>Agencia:</label><input type="text" id="agencia_analista" readonly class="input-readonly"></div>
            <div><label>Tel√©fono:</label><input type="text" id="telefono_analista" readonly class="input-readonly"></div>
        </div>

        <div class="grid-3">
            <div><label>C√≥d. SAP:</label><input type="text" id="codigo_sap_analista" required></div>
            <div><label>Cargo:</label><input type="text" id="cargo_analista" required></div>
            <div><label>Zona:</label><input type="text" id="zona_analista" required></div>
        </div>

        <!-- 4. FIRMAS -->
        <div class="seccion-header"><span class="numero">4</span> Firmas</div>
        <div class="grid-2">
            <div class="firma-card">
                <label>Colaborador (Recibe)</label>
                <canvas id="canvas_colaborador" class="canvas-firma"></canvas>
                <button type="button" class="btn-clear" onclick="limpiarFirma('colab')">Limpiar</button>
            </div>
            <div class="firma-card">
                <label>Analista (Entrega)</label>
                <canvas id="canvas_analista" class="canvas-firma"></canvas>
                <button type="button" class="btn-clear" onclick="limpiarFirma('ana')">Limpiar</button>
            </div>
        </div>

        <div style="margin-top:20px; background:#f9f9f9; padding:10px;">
            <label style="display:flex; align-items:center;">
                <input type="checkbox" id="aceptaCondiciones" required style="width:auto; margin-right:10px;">
                Acepto t√©rminos y condiciones.
            </label>
        </div>

        <button type="submit" class="btn-principal">GENERAR ACTA</button>
        <div id="estado-envio" style="text-align:center; margin-top:10px; font-weight:bold;"></div>

    </form>
</div>

<!-- --- SCRIPT JAVASCRIPT --- -->
<script>
    // URLS POWER AUTOMATE
    const URL_BUSQUEDA = "https://prod-29.westus.logic.azure.com:443/workflows/aed1a8e6527c409fa89020e534c2b5c5/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=HdukGAnPtKgdUMkC1kbIqxd6pRyp_oZ_Q35IAtZGr-M";
    const URL_ENVIO = "https://prod-47.westus.logic.azure.com:443/workflows/241ab4c9e8dd4b499963538107ded6ae/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=eYvcvi9mTH8wpW3_QaYhkhae6jiMGh4C38LaL1eEAZI";

    // Inicializaci√≥n
    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("fecha").value = new Date().toISOString().split("T")[0];
        const params = new URLSearchParams(window.location.search);
        if(params.get("serial")) document.getElementById("serial").value = params.get("serial");
    });

    // --- L√ìGICA DE B√öSQUEDA ---
    async function realizarBusqueda(cedula, tipo) {
        if(!cedula) { alert("Escribe una c√©dula primero"); return; }
        
        // Referencias DOM
        const sufijo = tipo === 'colab' ? 'colaborador' : 'analista';
        const icono = document.getElementById("icono-busqueda-" + sufijo);
        const msg = document.getElementById("msg-" + sufijo);
        
        // Estado visual: Cargando
        icono.innerHTML = '<span class="spinner"></span>'; 
        msg.innerText = "Conectando con base de datos...";
        msg.style.color = "#666";

        try {
            const resp = await fetch(URL_BUSQUEDA, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ cedula: cedula })
            });
            const data = await resp.json();

            // Restaurar icono
            icono.innerHTML = "üîç";

            if (data && data.nombre_colaborador) {
                msg.innerText = "‚úÖ Datos cargados correctamente";
                msg.style.color = "green";
                
                // Llenar campos
                if(tipo === 'colab') {
                    document.getElementById("nombre_colaborador").value = data.nombre_colaborador;
                    document.getElementById("agencia").value = data.agencia || "";
                    document.getElementById("telefono").value = data.telefono || "";
                } else {
                    document.getElementById("nombre_analista").value = data.nombre_colaborador;
                    document.getElementById("agencia_analista").value = data.agencia || "";
                    document.getElementById("telefono_analista").value = data.telefono || "";
                }
            } else {
                msg.innerText = "‚ùå C√©dula no encontrada en el sistema";
                msg.style.color = "red";
            }
        } catch (err) {
            console.error(err);
            icono.innerHTML = "üîç";
            msg.innerText = "‚ùå Error de conexi√≥n (Revisar consola)";
            msg.style.color = "red";
        }
    }

    // Funciones puente para los botones HTML
    window.buscarColaborador = () => realizarBusqueda(document.getElementById("cedula").value, 'colab');
    window.buscarAnalista = () => realizarBusqueda(document.getElementById("cedula_analista").value, 'analista');

    // --- L√ìGICA DE FIRMAS ---
    function setupCanvas(id) {
        const c = document.getElementById(id);
        const ctx = c.getContext("2d");
        let drawing = false;
        
        const resize = () => { c.width = c.offsetWidth; c.height = 120; };
        resize(); // Init

        const start = (e) => {
            drawing = true; ctx.beginPath();
            const {left, top} = c.getBoundingClientRect();
            // Soporte mouse/touch
            const x = (e.clientX || e.touches[0].clientX) - left;
            const y = (e.clientY || e.touches[0].clientY) - top;
            ctx.moveTo(x, y);
            e.preventDefault(); // Prevenir scroll en movil
        };
        const move = (e) => {
            if(!drawing) return;
            const {left, top} = c.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - left;
            const y = (e.clientY || e.touches[0].clientY) - top;
            ctx.lineTo(x, y); ctx.stroke();
            e.preventDefault();
        };
        const end = () => { drawing = false; };

        c.addEventListener("mousedown", start); c.addEventListener("touchstart", start, {passive:false});
        c.addEventListener("mousemove", move); c.addEventListener("touchmove", move, {passive:false});
        c.addEventListener("mouseup", end); c.addEventListener("touchend", end);
        c.addEventListener("mouseout", end);

        return {c, ctx};
    }

    const sigColab = setupCanvas("canvas_colaborador");
    const sigAna = setupCanvas("canvas_analista");

    window.limpiarFirma = (quien) => {
        const target = quien === 'colab' ? sigColab : sigAna;
        target.ctx.clearRect(0,0, target.c.width, target.c.height);
    };

    // --- ENV√çO FINAL ---
    document.getElementById("formulario").addEventListener("submit", async (e) => {
        e.preventDefault();
        const estadoDiv = document.getElementById("estado-envio");
        estadoDiv.innerHTML = '<span class="spinner" style="border-color: #666; border-top-color: #000;"></span> Enviando Acta...';

        // Recolectar datos (Resumido)
        const data = {
            cedula: document.getElementById("cedula").value,
            nombre_colaborador: document.getElementById("nombre_colaborador").value,
            // ... resto de campos ...
            firma_colaborador: sigColab.c.toDataURL().split(",")[1],
            firma_analista: sigAna.c.toDataURL().split(",")[1]
            // NOTA: Aqu√≠ ir√≠an todos los campos del JSON completo que te pas√© antes
        };
        
        // Simulaci√≥n de env√≠o para que veas el spinner (Descomenta el fetch real abajo)
        // await new Promise(r => setTimeout(r, 2000)); 
        
        try {
            const resp = await fetch(URL_ENVIO, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify(data)
            });
            if(resp.ok) {
                estadoDiv.innerText = "‚úÖ ¬°Enviado Exitosamente!";
                estadoDiv.style.color = "green";
                document.getElementById("formulario").reset();
                limpiarFirma('colab'); limpiarFirma('ana');
            } else {
                throw new Error("Error API");
            }
        } catch(err) {
            estadoDiv.innerText = "‚ùå Error al enviar datos (Verificar Power Automate)";
            estadoDiv.style.color = "red";
        }
    });
</script>

</body>
</html>
